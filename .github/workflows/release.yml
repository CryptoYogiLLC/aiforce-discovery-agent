name: Release

on:
  push:
    tags:
      - "v*"

env:
  GO_VERSION: "1.21"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ===========================================================================
  # BUILD BINARIES
  # ===========================================================================
  build-go-binaries:
    name: Build Go Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build network-scanner
        working-directory: collectors/network-scanner
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
          go build -ldflags="-s -w" -o bin/network-scanner-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} cmd/main.go

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: network-scanner-${{ matrix.goos }}-${{ matrix.goarch }}
          path: collectors/network-scanner/bin/

  # ===========================================================================
  # BUILD DOCKER IMAGES
  # ===========================================================================
  build-docker-images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service:
          - name: network-scanner
            context: collectors/network-scanner
          - name: code-analyzer
            context: collectors/code-analyzer
          - name: db-inspector
            context: collectors/db-inspector
          - name: enrichment
            context: platform/enrichment
          - name: pii-redactor
            context: platform/pii-redactor
          - name: approval-api
            context: gateway/approval-api
          - name: approval-ui
            context: gateway/approval-ui
          - name: transmitter
            context: gateway/transmitter
    steps:
      - uses: actions/checkout@v6

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "${{ matrix.service.context }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-go-binaries, build-docker-images]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # BUILD HELM CHART
  # ===========================================================================
  helm-package:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    needs: [build-docker-images]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Check if chart exists
        id: check
        run: |
          if [ -f "deploy/helm/discovery-agent/Chart.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Package Helm chart
        if: steps.check.outputs.exists == 'true'
        run: |
          helm package deploy/helm/discovery-agent --version ${GITHUB_REF#refs/tags/v}

      - name: Upload Helm chart
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: "*.tgz"
