"""Tests for vulnerability scanner."""

from src.analyzers.vulnerability_scanner import VulnerabilityScanner


class TestVulnerabilityScanner:
    """Test cases for VulnerabilityScanner."""

    def test_disabled_by_default(self):
        """Test scanner is disabled by default."""
        scanner = VulnerabilityScanner()
        assert scanner.is_enabled is False

    def test_scan_returns_empty_when_disabled(self):
        """Test scan returns empty when disabled."""
        scanner = VulnerabilityScanner(enabled=False)
        deps = [{"name": "lodash", "version": "4.17.0", "package_manager": "npm"}]

        result = scanner.scan(deps)

        assert result == []

    def test_offline_mode_default(self):
        """Test offline mode is default when enabled."""
        scanner = VulnerabilityScanner(enabled=True)
        assert scanner.is_offline_mode is True

    def test_enabled_with_custom_db_path(self):
        """Test scanner can be enabled with custom DB path."""
        scanner = VulnerabilityScanner(
            enabled=True, offline_mode=True, db_path="/custom/path/osv.json"
        )
        assert scanner.is_enabled is True
        assert scanner.is_offline_mode is True

    def test_scan_with_no_db_returns_empty(self):
        """Test scan with missing DB returns empty."""
        scanner = VulnerabilityScanner(
            enabled=True, offline_mode=True, db_path="/nonexistent/path.json"
        )
        deps = [{"name": "lodash", "version": "4.17.0", "package_manager": "npm"}]

        result = scanner.scan(deps)

        assert result == []

    def test_format_vulnerability_severity(self):
        """Test vulnerability severity formatting."""
        scanner = VulnerabilityScanner(enabled=True)

        # Test critical severity
        vuln = {
            "id": "CVE-2021-1234",
            "severity": [{"type": "CVSS_V3", "score": "9.8"}],
            "summary": "Critical vulnerability",
            "affected": [],
        }
        result = scanner._format_vulnerability(vuln)
        assert result["severity"] == "critical"

        # Test high severity
        vuln["severity"] = [{"type": "CVSS_V3", "score": "7.5"}]
        result = scanner._format_vulnerability(vuln)
        assert result["severity"] == "high"

        # Test medium severity
        vuln["severity"] = [{"type": "CVSS_V3", "score": "5.0"}]
        result = scanner._format_vulnerability(vuln)
        assert result["severity"] == "medium"

        # Test low severity
        vuln["severity"] = [{"type": "CVSS_V3", "score": "2.0"}]
        result = scanner._format_vulnerability(vuln)
        assert result["severity"] == "low"
