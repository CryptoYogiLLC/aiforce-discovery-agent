# =============================================================================
# AIForce Discovery Agent - Docker Compose Configuration
# =============================================================================
# Usage:
#   docker-compose up -d                    # Start core infrastructure
#   docker-compose --profile network up -d  # Include network scanner
#   docker-compose --profile database up -d # Include database inspector
#   docker-compose --profile code up -d     # Include code analyzer (Phase 2)
#   docker-compose --profile all up -d      # Start everything
#   docker-compose down                     # Stop all services
#   docker-compose down -v                  # Stop and remove volumes
# =============================================================================

services:
  # =============================================================================
  # INFRASTRUCTURE
  # These services start by default with `docker-compose up -d`
  # =============================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: discovery-rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5674}:5672"
      - "${RABBITMQ_MGMT_PORT:-15674}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: discovery
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-discovery}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./platform/event-bus/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./platform/event-bus/definitions.json:/etc/rabbitmq/definitions.json:ro
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - discovery-network
    restart: unless-stopped

  postgres:
    # Using same pgvector image as AIForce-Assess parent project for consistency
    # Enables future vector-based features (embedding search, similarity matching)
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: discovery-postgres
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-discovery}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-discovery}
      POSTGRES_DB: discovery_agent
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-discovery} -d discovery_agent",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - discovery-network
    restart: unless-stopped

  redis:
    # Using redis:8-alpine for consistency with AIForce-Assess parent project
    image: redis:8-alpine
    container_name: discovery-redis
    ports:
      - "${REDIS_PORT:-6381}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - discovery-network
    restart: unless-stopped

  # =============================================================================
  # COLLECTORS (use profiles to enable)
  # Start with: docker-compose --profile <profile> up -d
  # =============================================================================
  network-scanner:
    build:
      context: ./collectors/network-scanner
      dockerfile: Dockerfile
    container_name: discovery-network-scanner
    profiles: ["network", "all"]
    # Note: network_mode: host is needed for production scanning but doesn't work
    # on Docker Desktop for Mac. Using bridge networks for local development.
    environment:
      SCANNER_RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      SCANNER_LOGGING_LEVEL: debug
      SCANNER_SCANNER_SUBNETS: "172.28.0.0/24"
      SCANNER_SCANNER_PORT_RANGES: ""
      SCANNER_SCANNER_COMMON_PORTS: "22,80,443,3000,3306,5000,5432,6379,8000,8080,9000,9090,11211,27017"
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - discovery-network
    restart: unless-stopped

  code-analyzer:
    build:
      context: ./collectors/code-analyzer
      dockerfile: Dockerfile
    container_name: discovery-code-analyzer
    profiles: ["code", "all"]
    environment:
      RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - code_repos:/repos:ro
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - discovery-network
    restart: unless-stopped

  db-inspector:
    build:
      context: ./collectors/db-inspector
      dockerfile: Dockerfile
    container_name: discovery-db-inspector
    profiles: ["database", "all"]
    environment:
      RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - discovery-network
    restart: unless-stopped

  # =============================================================================
  # PROCESSING PIPELINE
  # Unified processor handles enrichment, PII redaction, and scoring
  # =============================================================================
  processor:
    build:
      context: ./platform/processor
      dockerfile: Dockerfile
    container_name: discovery-processor
    profiles: ["processor", "all"]
    environment:
      RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      POSTGRES_URL: postgresql://${POSTGRES_USER:-discovery}:${POSTGRES_PASSWORD:-discovery}@postgres:5432/discovery_agent
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - discovery-network
    restart: unless-stopped

  # =============================================================================
  # GATEWAY
  # Approval UI and API for reviewing discovered items
  # =============================================================================
  approval-api:
    build:
      context: ./gateway/approval-api
      dockerfile: Dockerfile
    container_name: discovery-approval-api
    profiles: ["gateway", "all"]
    ports:
      - "3001:3001"
    environment:
      RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-discovery}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-discovery}
      POSTGRES_DB: discovery_agent
      REDIS_URL: redis://redis:6379
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - discovery-network
    restart: unless-stopped

  approval-ui:
    build:
      context: ./gateway/approval-ui
      dockerfile: Dockerfile
    container_name: discovery-approval-ui
    profiles: ["gateway", "all"]
    ports:
      - "3000:80"
    environment:
      VITE_API_URL: http://localhost:3001
    depends_on:
      - approval-api
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - discovery-network
    restart: unless-stopped

  transmitter:
    build:
      context: ./gateway/transmitter
      dockerfile: Dockerfile
    container_name: discovery-transmitter
    profiles: ["gateway", "all"]
    environment:
      TRANSMITTER_RABBITMQ_URL: amqp://discovery:${RABBITMQ_PASSWORD:-discovery}@rabbitmq:5672/
      TRANSMITTER_DATABASE_URL: postgresql://${POSTGRES_USER:-discovery}:${POSTGRES_PASSWORD:-discovery}@postgres:5432/discovery_agent
      TRANSMITTER_DESTINATION_URL: ${AIFORCE_API_URL:-https://api.aiforce-assess.com}
      TRANSMITTER_AUTH_TOKEN: ${DISCOVERY_AGENT_TOKEN:-}
      TRANSMITTER_LOG_LEVEL: ${LOG_LEVEL:-info}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - discovery-network
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  discovery-network:
    driver: bridge
    name: discovery-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  rabbitmq_data:
    name: discovery-rabbitmq-data
  postgres_data:
    name: discovery-postgres-data
  redis_data:
    name: discovery-redis-data
  code_repos:
    name: discovery-code-repos
